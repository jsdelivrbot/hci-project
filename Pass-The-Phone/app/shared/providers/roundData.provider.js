"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var nativescript_texttospeech_1 = require("nativescript-texttospeech");
var Sqlite = require("nativescript-sqlite");
var file_system_1 = require("file-system");
var RoundDataProvider = /** @class */ (function () {
    function RoundDataProvider() {
        this.players = [];
        this.groups = [];
        this.teams = [];
        this.hasQuestions = false;
        this.answerCount = 2;
        this.playersInRound = [];
        this.groupFetch_completed = false;
        //set a default boolean for a button to animate when the tts plugin 'speaks'
        this.isSpeaking = false;
        this.hasRemainingPlayers = true;
        this.TTS = new nativescript_texttospeech_1.TNSTextToSpeech();
    }
    // Return a player that haven't played more than authorizes times
    // Returns null if no elligible player. Hence need to go to summary page
    RoundDataProvider.prototype.getRandomPlayer = function (questionAsker) {
        var elligiblePlayers = [];
        var j = 0;
        var k = 0;
        //populate elligible players array
        console.log("question asker: ".concat(questionAsker));
        for (var i = 0; i < this.players.length; i++) {
            if (this.players[i].answerCount < this.answerCount) {
                console.log("question asker: ".concat(this.players[i].name));
                if (this.players[i].name != questionAsker && this.playersInRound.indexOf(this.players[i].name) < 0 && (this.currentPlayer == null || this.players[i].name != this.currentPlayer.name)) {
                    elligiblePlayers[k] = this.players[i];
                    k++;
                }
                else if (this.players[i].name != questionAsker && this.players.length == 2) {
                    elligiblePlayers[k] = this.players[i];
                    k++;
                }
                j++;
            }
        }
        if (j == 0) {
            return null;
        }
        else {
            this.hasRemainingPlayers = j > 1;
            console.log(j > 1);
            var random = Math.floor(Math.random() * k);
            console.log("random ".concat((random).toString()));
            console.log("elligible ".concat((elligiblePlayers.length).toString()));
            this.playersInRound.push(elligiblePlayers[random].name);
            if (this.playersInRound.length == this.players.length) {
                console.log("round done");
                this.playersInRound = [];
            }
            return elligiblePlayers[random];
        }
    };
    //trouver un ami pour demander une question, code beurk
    RoundDataProvider.prototype.getRandomFriend = function (player) {
        var friends = [];
        player.team.players.forEach(function (p) {
            if (p.name != player.name) {
                friends.push(p);
            }
        });
        var index = Math.floor(Math.random() * friends.length);
        if (index > 0) {
            return friends[index].name;
        }
        else {
            return friends[0].name;
        }
    };
    RoundDataProvider.prototype.speak = function (text) {
        var _this = this;
        this.isSpeaking = true;
        var speakOptions = {
            text: text,
            speakRate: 0.5,
            pitch: 1,
            queue: true,
            finishedCallback: (function () {
                _this.isSpeaking = false;
            })
        };
        this.TTS.speak(speakOptions);
    };
    RoundDataProvider.prototype.stopSpeaking = function () {
        this.isSpeaking = false;
        this.TTS.destroy();
    };
    RoundDataProvider.prototype.calculateTeamCount = function () {
        var teamCount = 0;
        if ((this.players.length % 2 == 0 || this.players.length % 3 == 0) && this.players.length > 3) {
            //team creation of 2 or 3 player is possible
            if (this.players.length % 3 == 0) {
                //teams of 3 will be created
                teamCount = this.players.length / 3;
            }
            else {
                //teams of 2 will be created
                teamCount = this.players.length / 2;
            }
            return teamCount;
        }
        else {
            // no team creation is possible
            return 0;
        }
    };
    RoundDataProvider.prototype.getProgress = function () {
        var questionsAnswered = 0;
        this.players.forEach(function (player) {
            questionsAnswered += player.answerCount;
        });
        return (questionsAnswered / (this.answerCount * this.players.length)) * 100;
    };
    RoundDataProvider.prototype.getPlayersInTeam = function (team) {
        return team.players;
    };
    RoundDataProvider.prototype.getExistingAndRemainingPlayers = function (team) {
        var noTeamPlayers = [];
        var j = 0;
        //populate elligible players array
        for (var i = 0; i < this.players.length; i++) {
            if (this.players[i].team == null /*|| this.players[i].team == team*/) {
                noTeamPlayers[j] = this.players[i];
                j++;
            }
            else if (this.players[i].team.name == team.name) {
                this.players[i].isSelected = true;
                noTeamPlayers[j] = this.players[i];
                j++;
            }
        }
        return noTeamPlayers;
    };
    RoundDataProvider.prototype.defineQuestionAsker = function () {
        this.questionAsker;
        return this.questionAsker;
    };
    RoundDataProvider.prototype.clearData = function () {
        console.log("Clearing Data...");
        this.triviaQuestion = null;
        this.currentPlayer = null;
        this.group = null;
        for (var i = 0; i < this.players.length; i++) {
            delete this.players[i];
        }
        for (var i = 0; i < this.teams.length; i++) {
            delete this.teams[i];
        }
        this.players = [];
        this.teams = [];
        this.subjectId = "";
        this.gameMode = "";
    };
    RoundDataProvider.prototype.clearGroups = function () {
        for (var i = 0; i < this.groups.length; i++) {
            delete this.groups[i];
        }
        this.groups = [];
    };
    RoundDataProvider.prototype.saveGroups = function () {
        console.log("Saving groups...");
        var str = JSON.stringify(this.groups, null, 4);
        var folderName = "data";
        var fileName = "data.json";
        var documents = file_system_1.knownFolders.documents();
        var folder = documents.getFolder(folderName);
        var file = folder.getFile(fileName);
        file.writeText(str)
            .then(function (result) {
            file.readText()
                .then(function (res) {
                var successMessage = "Successfully saved in " + file.path;
                console.log(successMessage);
                console.log(": " + res);
            });
        }).catch(function (err) {
            console.log(err);
        });
    };
    RoundDataProvider.prototype.checkForData = function (callback) {
        var folderName = "data";
        var fileName = "data.json";
        var documents = file_system_1.knownFolders.documents();
        var folder = documents.getFolder(folderName);
        var file = folder.getFile(fileName);
        console.log("check");
        file.readText().then(function (res) {
            console.log(res.length);
            console.log(res);
            var data = JSON.parse(res);
            callback(data.length <= 0);
        }).catch(function (err) {
            console.log(err.stack);
            callback(true);
        });
    };
    RoundDataProvider.prototype.loadGroups = function () {
        var _this = this;
        console.log("Loading groups...");
        return new Promise(function (resolve, reject) {
            _this.clearGroups();
            var folderName = "data";
            var fileName = "data.json";
            var documents = file_system_1.knownFolders.documents();
            var folder = documents.getFolder(folderName);
            var file = folder.getFile(fileName);
            file.readText().then(function (res) {
                var writtenContent = res;
                console.log("Successful Read: " + writtenContent);
                if (writtenContent == "") {
                    _this.saveGroups();
                    resolve("{}");
                }
                var data = JSON.parse(writtenContent);
                console.log("length: " + data.length);
                for (var i = 0; i < data.length; i++) {
                    _this.groups.push(data[i]);
                }
                resolve(writtenContent);
            }).catch(function (err) {
                console.log(err.stack);
                reject(err);
            });
        });
    };
    RoundDataProvider = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [])
    ], RoundDataProvider);
    return RoundDataProvider;
}());
exports.RoundDataProvider = RoundDataProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91bmREYXRhLnByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicm91bmREYXRhLnByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTJDO0FBQzNDLHVFQUEwRTtBQUMxRSxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUM1QywyQ0FBeUQ7QUFXekQ7SUFtQ0k7UUE1Qk8sWUFBTyxHQUFjLEVBQUUsQ0FBQztRQUN4QixXQUFNLEdBQWEsRUFBRSxDQUFDO1FBQ3RCLFVBQUssR0FBWSxFQUFFLENBQUM7UUFDcEIsaUJBQVksR0FBWSxLQUFLLENBQUM7UUFZNUIsZ0JBQVcsR0FBVSxDQUFDLENBQUM7UUFFekIsbUJBQWMsR0FBYSxFQUFFLENBQUE7UUFJN0IseUJBQW9CLEdBQVksS0FBSyxDQUFDO1FBRTdDLDRFQUE0RTtRQUM1RSxlQUFVLEdBQVksS0FBSyxDQUFDO1FBUXJCLHdCQUFtQixHQUFZLElBQUksQ0FBQztRQUh2QyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksMkNBQWUsRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFJRCxpRUFBaUU7SUFDakUsd0VBQXdFO0lBQ2pFLDJDQUFlLEdBQXRCLFVBQXVCLGFBQWE7UUFDaEMsSUFBSSxnQkFBZ0IsR0FBYyxFQUFFLENBQUM7UUFDckMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ1YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ1Ysa0NBQWtDO1FBQ2xDLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUE7UUFDckQsR0FBRyxDQUFBLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBQyxDQUFDLEVBQUUsRUFBQyxDQUFDO1lBQ3ZDLEVBQUUsQ0FBQSxDQUFDLElBQUksQ0FBQyxPQUFP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T0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsR0FBRSxjQUFjLENBQUMsQ0FBQztnQkFFakQsRUFBRSxDQUFBLENBQUMsY0FBYyxJQUFFLEVBQUUsQ0FBQyxDQUFBLENBQUM7b0JBQ25CLEtBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztvQkFDbEIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNsQixDQUFDO2dCQUVELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQ3RDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFFcEMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7b0JBQ2pDLEtBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM5QixDQUFDO2dCQUVELE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUU1QixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQSxHQUFHO2dCQUNSLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN2QixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUVMLENBQUM7SUEzUlUsaUJBQWlCO1FBRDdCLGlCQUFVLEVBQUU7O09BQ0EsaUJBQWlCLENBK1I3QjtJQUFELHdCQUFDO0NBQUEsQUEvUkQsSUErUkM7QUEvUlksOENBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVE5TVGV4dFRvU3BlZWNoLCBTcGVha09wdGlvbnMgfSBmcm9tICduYXRpdmVzY3JpcHQtdGV4dHRvc3BlZWNoJztcbnZhciBTcWxpdGUgPSByZXF1aXJlKFwibmF0aXZlc2NyaXB0LXNxbGl0ZVwiKTtcbmltcG9ydCB7IGtub3duRm9sZGVycywgRmlsZSwgRm9sZGVyIH0gZnJvbSBcImZpbGUtc3lzdGVtXCI7XG5cblxuaW1wb3J0IHtUcml2aWFRdWVzdGlvbn0gZnJvbSBcIi4uL3RyaXZpYVF1ZXN0aW9uXCI7XG5pbXBvcnQge1RlYW19IGZyb20gXCIuLi90ZWFtXCI7XG5pbXBvcnQge1BsYXllcn0gZnJvbSBcIi4uL3BsYXllclwiO1xuaW1wb3J0IHtHcm91cH0gZnJvbSBcIi4uL2dyb3VwXCI7XG5cblxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUm91bmREYXRhUHJvdmlkZXIge1xuICAgIFxuICAgIHB1YmxpYyB0cml2aWFRdWVzdGlvbjogVHJpdmlhUXVlc3Rpb247XG4gICAgcHVibGljIGN1cnJlbnRQbGF5ZXI6IFBsYXllcjtcbiAgICBwdWJsaWMgcXVlc3Rpb25Bc2tlcjogUGxheWVyO1xuICAgIFxuICAgIHB1YmxpYyBncm91cDogR3JvdXA7XG4gICAgcHVibGljIHBsYXllcnMgOiBQbGF5ZXJbXSA9IFtdO1xuICAgIHB1YmxpYyBncm91cHMgOiBHcm91cFtdID0gW107ICAgIFxuICAgIHB1YmxpYyB0ZWFtcyA6IFRlYW1bXSA9IFtdO1xuICAgIHB1YmxpYyBoYXNRdWVzdGlvbnM6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwdWJsaWMgcGF0aDogc3RyaW5nO1xuICAgIHB1YmxpYyBxdWVzdGlvbnM6c3RyaW5nW107XG4gICAgcHVibGljIGFuc3dlcnM6W3N0cmluZ1tdXTtcbiAgICBwdWJsaWMgc3ViamVjdElkOiBzdHJpbmc7XG4gICAgcHVibGljIHN1YmplY3ROYW1lOiBzdHJpbmc7XG4gICAgcHVibGljIGNhdGVnb3J5OnN0cmluZztcbiAgICBwdWJsaWMgdHlwZTpzdHJpbmc7XG4gICAgcHVibGljIGRpZmZpY3VsdHk6c3RyaW5nO1xuICAgIFxuICAgIHB1YmxpYyBnYW1lTW9kZTogc3RyaW5nO1xuICAgIFxuICAgIHJlYWRvbmx5IGFuc3dlckNvdW50Om51bWJlciA9IDI7XG5cbiAgICBwdWJsaWMgcGxheWVyc0luUm91bmQ6IHN0cmluZ1tdID0gW11cbiAgICBcbiAgICBwcml2YXRlIGRhdGFiYXNlOiBhbnk7XG5cbiAgICBwdWJsaWMgZ3JvdXBGZXRjaF9jb21wbGV0ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIC8vc2V0IGEgZGVmYXVsdCBib29sZWFuIGZvciBhIGJ1dHRvbiB0byBhbmltYXRlIHdoZW4gdGhlIHR0cyBwbHVnaW4gJ3NwZWFrcydcbiAgICBpc1NwZWFraW5nOiBib29sZWFuID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBUVFM6IFROU1RleHRUb1NwZWVjaDtcbiAgICBcbiAgICBcbiAgICBwdWJsaWMgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuVFRTID0gbmV3IFROU1RleHRUb1NwZWVjaCgpO1xuICAgIH1cbiAgICBcbiAgICBwdWJsaWMgaGFzUmVtYWluaW5nUGxheWVyczogYm9vbGVhbiA9IHRydWU7XG5cbiAgICAvLyBSZXR1cm4gYSBwbGF5ZXIgdGhhdCBoYXZlbid0IHBsYXllZCBtb3JlIHRoYW4gYXV0aG9yaXplcyB0aW1lc1xuICAgIC8vIFJldHVybnMgbnVsbCBpZiBubyBlbGxpZ2libGUgcGxheWVyLiBIZW5jZSBuZWVkIHRvIGdvIHRvIHN1bW1hcnkgcGFnZVxuICAgIHB1YmxpYyBnZXRSYW5kb21QbGF5ZXIocXVlc3Rpb25Bc2tlcil7XG4gICAgICAgIHZhciBlbGxpZ2libGVQbGF5ZXJzIDogUGxheWVyW10gPSBbXTtcbiAgICAgICAgbGV0IGogPSAwO1xuICAgICAgICBsZXQgayA9IDA7XG4gICAgICAgIC8vcG9wdWxhdGUgZWxsaWdpYmxlIHBsYXllcnMgYXJyYXlcbiAgICAgICAgY29uc29sZS5sb2coXCJxdWVzdGlvbiBhc2tlcjogXCIuY29uY2F0KHF1ZXN0aW9uQXNrZXIpKVxuICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDx0aGlzLnBsYXllcnMubGVuZ3RoO2krKyl7XG4gICAgICAgICAgICBpZih0aGlzLnBsYXllcnNbaV0uYW5zd2VyQ291bnQ8dGhpcy5hbnN3ZXJDb3VudCl7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJxdWVzdGlvbiBhc2tlcjogXCIuY29uY2F0KHRoaXMucGxheWVyc1tpXS5uYW1lKSlcbiAgICAgICAgICAgICAgICBpZih0aGlzLnBsYXllcnNbaV0ubmFtZSAhPSBxdWVzdGlvbkFza2VyICYmIHRoaXMucGxheWVyc0luUm91bmQuaW5kZXhPZih0aGlzLnBsYXllcnNbaV0ubmFtZSkgPCAwICYmICh0aGlzLmN1cnJlbnRQbGF5ZXIgPT0gbnVsbCB8fCB0aGlzLnBsYXllcnNbaV0ubmFtZSAhPSB0aGlzLmN1cnJlbnRQbGF5ZXIubmFtZSkpe1xuICAgICAgICAgICAgICAgICAgICBlbGxpZ2libGVQbGF5ZXJzW2tdPXRoaXMucGxheWVyc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaysrO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZih0aGlzLnBsYXllcnNbaV0ubmFtZSAhPSBxdWVzdGlvbkFza2VyICYmIHRoaXMucGxheWVycy5sZW5ndGggPT0gMil7XG4gICAgICAgICAgICAgICAgICAgIGVsbGlnaWJsZVBsYXllcnNba109dGhpcy5wbGF5ZXJzW2ldO1xuICAgICAgICAgICAgICAgICAgICBrKys7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGorKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZihqID09IDApe1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgdGhpcy5oYXNSZW1haW5pbmdQbGF5ZXJzID0gaiA+IDE7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhqID4gMSlcbiAgICAgICAgICAgIGxldCByYW5kb20gPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBrKTsgXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInJhbmRvbSBcIi5jb25jYXQoKHJhbmRvbSkudG9TdHJpbmcoKSkpXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImVsbGlnaWJsZSBcIi5jb25jYXQoKGVsbGlnaWJsZVBsYXllcnMubGVuZ3RoKS50b1N0cmluZygpKSlcbiAgICAgICAgICAgIHRoaXMucGxheWVyc0luUm91bmQucHVzaChlbGxpZ2libGVQbGF5ZXJzW3JhbmRvbV0ubmFtZSlcbiAgICAgICAgICAgIGlmKHRoaXMucGxheWVyc0luUm91bmQubGVuZ3RoID09IHRoaXMucGxheWVycy5sZW5ndGgpe1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicm91bmQgZG9uZVwiKVxuICAgICAgICAgICAgICAgIHRoaXMucGxheWVyc0luUm91bmQgPSBbXVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGVsbGlnaWJsZVBsYXllcnNbcmFuZG9tXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vdHJvdXZlciB1biBhbWkgcG91ciBkZW1hbmRlciB1bmUgcXVlc3Rpb24sIGNvZGUgYmV1cmtcbiAgICBwdWJsaWMgZ2V0UmFuZG9tRnJpZW5kKHBsYXllcjogUGxheWVyKXtcbiAgICAgICAgbGV0IGZyaWVuZHMgPSBbXTtcbiAgICAgICAgcGxheWVyLnRlYW0ucGxheWVycy5mb3JFYWNoKHAgPT4ge1xuICAgICAgICAgICAgaWYocC5uYW1lICE9IHBsYXllci5uYW1lKXtcbiAgICAgICAgICAgICAgICBmcmllbmRzLnB1c2gocCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBsZXQgaW5kZXggPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqZnJpZW5kcy5sZW5ndGgpO1xuICAgICAgICBpZihpbmRleCA+IDApe1xuICAgICAgICAgICAgcmV0dXJuIGZyaWVuZHNbaW5kZXhdLm5hbWU7XG4gICAgICAgIH0gZWxzZXtcbiAgICAgICAgICAgIHJldHVybiBmcmllbmRzWzBdLm5hbWU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3BlYWsodGV4dDogc3RyaW5nKXtcbiAgICAgICAgdGhpcy5pc1NwZWFraW5nID0gdHJ1ZTtcbiAgICAgICAgbGV0IHNwZWFrT3B0aW9uczogU3BlYWtPcHRpb25zID0ge1xuICAgICAgICAgICAgdGV4dDogdGV4dCxcbiAgICAgICAgICAgIHNwZWFrUmF0ZTogMC41LFxuICAgICAgICAgICAgcGl0Y2g6IDEsXG4gICAgICAgICAgICBxdWV1ZTogdHJ1ZSxcbiAgICAgICAgICAgIGZpbmlzaGVkQ2FsbGJhY2s6ICgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5pc1NwZWFraW5nID0gZmFsc2U7XG4gICAgICAgICAgICB9KSAgXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5UVFMuc3BlYWsoc3BlYWtPcHRpb25zKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RvcFNwZWFraW5nKCl7XG4gICAgICAgIHRoaXMuaXNTcGVha2luZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLlRUUy5kZXN0cm95KCk7XG4gICAgfVxuICAgIFxuICAgIHB1YmxpYyBjYWxjdWxhdGVUZWFtQ291bnQoKXtcbiAgICAgICAgbGV0IHRlYW1Db3VudCA9IDA7XG4gICAgICAgIGlmKCAodGhpcy5wbGF5ZXJzLmxlbmd0aCUyID09IDAgfHwgdGhpcy5wbGF5ZXJzLmxlbmd0aCUzID09IDAgKSAmJiB0aGlzLnBsYXllcnMubGVuZ3RoID4gMykge1xuICAgICAgICAgICAgLy90ZWFtIGNyZWF0aW9uIG9mIDIgb3IgMyBwbGF5ZXIgaXMgcG9zc2libGVcbiAgICAgICAgICAgIGlmKHRoaXMucGxheWVycy5sZW5ndGglMyA9PSAwICl7XG4gICAgICAgICAgICAgICAgLy90ZWFtcyBvZiAzIHdpbGwgYmUgY3JlYXRlZFxuICAgICAgICAgICAgICAgIHRlYW1Db3VudCA9IHRoaXMucGxheWVycy5sZW5ndGgvMztcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIC8vdGVhbXMgb2YgMiB3aWxsIGJlIGNyZWF0ZWRcbiAgICAgICAgICAgICAgICB0ZWFtQ291bnQgPSB0aGlzLnBsYXllcnMubGVuZ3RoLzI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGVhbUNvdW50O1xuICAgICAgICAgICAgXG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgLy8gbm8gdGVhbSBjcmVhdGlvbiBpcyBwb3NzaWJsZVxuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgfVxuXG4gICAgcHVibGljIGdldFByb2dyZXNzKCl7XG4gICAgICAgIHZhciBxdWVzdGlvbnNBbnN3ZXJlZCA6IG51bWJlciA9IDA7XG4gICAgICAgIHRoaXMucGxheWVycy5mb3JFYWNoKHBsYXllciA9PntcbiAgICAgICAgICAgIHF1ZXN0aW9uc0Fuc3dlcmVkICs9IHBsYXllci5hbnN3ZXJDb3VudDtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiAocXVlc3Rpb25zQW5zd2VyZWQvKHRoaXMuYW5zd2VyQ291bnQgKiB0aGlzLnBsYXllcnMubGVuZ3RoKSkgKiAxMDA7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFBsYXllcnNJblRlYW0odGVhbTogVGVhbSk6IFBsYXllcltde1xuICAgICAgICByZXR1cm4gdGVhbS5wbGF5ZXJzO1xuICAgIH1cbiAgICBcbiAgICBwdWJsaWMgZ2V0RXhpc3RpbmdBbmRSZW1haW5pbmdQbGF5ZXJzKHRlYW06IFRlYW0pOiBQbGF5ZXJbXXtcbiAgICAgICAgdmFyIG5vVGVhbVBsYXllcnMgOiBQbGF5ZXJbXSA9IFtdO1xuICAgICAgICBsZXQgaiA9IDA7XG4gICAgICAgIFxuICAgICAgICAvL3BvcHVsYXRlIGVsbGlnaWJsZSBwbGF5ZXJzIGFycmF5XG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPHRoaXMucGxheWVycy5sZW5ndGg7aSsrKXtcbiAgICAgICAgICAgIGlmKHRoaXMucGxheWVyc1tpXS50ZWFtID09IG51bGwgLyp8fCB0aGlzLnBsYXllcnNbaV0udGVhbSA9PSB0ZWFtKi8gKXtcbiAgICAgICAgICAgICAgICBub1RlYW1QbGF5ZXJzW2pdPXRoaXMucGxheWVyc1tpXTtcbiAgICAgICAgICAgICAgICBqKys7XG4gICAgICAgICAgICB9IGVsc2UgaWYodGhpcy5wbGF5ZXJzW2ldLnRlYW0ubmFtZSA9PSAgdGVhbS5uYW1lKXtcbiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnNbaV0uaXNTZWxlY3RlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgbm9UZWFtUGxheWVyc1tqXT10aGlzLnBsYXllcnNbaV07XG4gICAgICAgICAgICAgICAgaisrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gbm9UZWFtUGxheWVycztcbiAgICB9XG5cbiAgICBwdWJsaWMgZGVmaW5lUXVlc3Rpb25Bc2tlcigpe1xuXG4gICAgICAgIHRoaXMucXVlc3Rpb25Bc2tlcjtcblxuICAgICAgICByZXR1cm4gdGhpcy5xdWVzdGlvbkFza2VyO1xuICAgIH1cbiAgICBcbiAgICBcbiAgICBwdWJsaWMgY2xlYXJEYXRhKCl7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ2xlYXJpbmcgRGF0YS4uLlwiKTtcbiAgICAgICAgdGhpcy50cml2aWFRdWVzdGlvbiA9IG51bGw7IFxuICAgICAgICB0aGlzLmN1cnJlbnRQbGF5ZXI9IG51bGw7XG4gICAgICAgIHRoaXMuZ3JvdXA9IG51bGw7XG4gICAgICAgIFxuICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDx0aGlzLnBsYXllcnMubGVuZ3RoO2krKyl7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5wbGF5ZXJzW2ldO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDx0aGlzLnRlYW1zLmxlbmd0aDtpKyspe1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMudGVhbXNbaV07XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHRoaXMucGxheWVycz0gW107XG4gICAgICAgIHRoaXMudGVhbXM9IFtdO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5zdWJqZWN0SWQ9IFwiXCI7XG4gICAgICAgIFxuICAgICAgICB0aGlzLmdhbWVNb2RlPSBcIlwiO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYXJHcm91cHMoKXtcbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8dGhpcy5ncm91cHMubGVuZ3RoO2krKyl7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5ncm91cHNbaV07XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmdyb3Vwcz0gW107XG4gICAgfVxuXG4gIHB1YmxpYyBzYXZlR3JvdXBzKCl7XG4gICAgY29uc29sZS5sb2coXCJTYXZpbmcgZ3JvdXBzLi4uXCIpO1xuICAgIHZhciBzdHIgPSBKU09OLnN0cmluZ2lmeSh0aGlzLmdyb3VwcywgbnVsbCwgNCk7XG5cbiAgICBsZXQgZm9sZGVyTmFtZSA9IFwiZGF0YVwiO1xuICAgIGxldCBmaWxlTmFtZSA9IFwiZGF0YS5qc29uXCI7XG5cbiAgICBsZXQgZG9jdW1lbnRzID0ga25vd25Gb2xkZXJzLmRvY3VtZW50cygpO1xuICAgIGxldCBmb2xkZXIgPSBkb2N1bWVudHMuZ2V0Rm9sZGVyKGZvbGRlck5hbWUpO1xuICAgIGxldCBmaWxlID0gZm9sZGVyLmdldEZpbGUoZmlsZU5hbWUpO1xuICBcbiAgICBmaWxlLndyaXRlVGV4dChzdHIpXG4gICAgICAgIC50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICBmaWxlLnJlYWRUZXh0KClcbiAgICAgICAgICAgICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICAgICAgICAgICAgIGxldCBzdWNjZXNzTWVzc2FnZSA9IFwiU3VjY2Vzc2Z1bGx5IHNhdmVkIGluIFwiICsgZmlsZS5wYXRoO1xuICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHN1Y2Nlc3NNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIjogXCIrIHJlcyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBjaGVja0ZvckRhdGEoY2FsbGJhY2spe1xuICAgIGxldCBmb2xkZXJOYW1lID0gXCJkYXRhXCI7XG4gICAgbGV0IGZpbGVOYW1lID0gXCJkYXRhLmpzb25cIjtcbiAgICBsZXQgZG9jdW1lbnRzID0ga25vd25Gb2xkZXJzLmRvY3VtZW50cygpO1xuICAgIGxldCBmb2xkZXIgPSBkb2N1bWVudHMuZ2V0Rm9sZGVyKGZvbGRlck5hbWUpO1xuICAgIGxldCBmaWxlID0gZm9sZGVyLmdldEZpbGUoZmlsZU5hbWUpO1xuICAgIGNvbnNvbGUubG9nKFwiY2hlY2tcIik7XG4gICAgZmlsZS5yZWFkVGV4dCgpLnRoZW4ocmVzID0+IHtcbiAgICAgICAgY29uc29sZS5sb2cocmVzLmxlbmd0aCk7XG4gICAgICAgIGNvbnNvbGUubG9nKHJlcyk7XG4gICAgICAgIGxldCBkYXRhID0gSlNPTi5wYXJzZShyZXMpO1xuICAgICAgICBjYWxsYmFjayhkYXRhLmxlbmd0aCA8PSAwKTtcbiAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhlcnIuc3RhY2spO1xuICAgICAgICBjYWxsYmFjayh0cnVlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBsb2FkR3JvdXBzKCk6IFByb21pc2UgPGFueT4ge1xuICAgIGNvbnNvbGUubG9nKFwiTG9hZGluZyBncm91cHMuLi5cIik7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUscmVqZWN0KSA9PiB7XG5cbiAgICAgICAgdGhpcy5jbGVhckdyb3VwcygpO1xuICAgICAgICBcbiAgICAgICAgbGV0IGZvbGRlck5hbWUgPSBcImRhdGFcIjtcbiAgICAgICAgbGV0IGZpbGVOYW1lID0gXCJkYXRhLmpzb25cIjtcbiAgICAgICAgbGV0IGRvY3VtZW50cyA9IGtub3duRm9sZGVycy5kb2N1bWVudHMoKTtcbiAgICAgICAgbGV0IGZvbGRlciA9IGRvY3VtZW50cy5nZXRGb2xkZXIoZm9sZGVyTmFtZSk7XG4gICAgICAgIFxuICAgICAgICBsZXQgZmlsZSA9IGZvbGRlci5nZXRGaWxlKGZpbGVOYW1lKTtcbiAgICBcbiAgICAgICAgZmlsZS5yZWFkVGV4dCgpLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICAgIGxldCB3cml0dGVuQ29udGVudCA9IHJlcztcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU3VjY2Vzc2Z1bCBSZWFkOiBcIisgd3JpdHRlbkNvbnRlbnQpO1xuXG4gICAgICAgICAgICBpZih3cml0dGVuQ29udGVudD09XCJcIil7XG4gICAgICAgICAgICAgICAgdGhpcy5zYXZlR3JvdXBzKCk7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShcInt9XCIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZGF0YSA9IEpTT04ucGFyc2Uod3JpdHRlbkNvbnRlbnQpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJsZW5ndGg6IFwiK2RhdGEubGVuZ3RoKTtcbiAgICBcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwO2kgPCBkYXRhLmxlbmd0aDtpKyspIHtcbiAgICAgICAgICAgICAgICB0aGlzLmdyb3Vwcy5wdXNoKGRhdGFbaV0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXNvbHZlKHdyaXR0ZW5Db250ZW50KTtcbiAgICBcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVyci5zdGFjayk7XG4gICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgfVxuICAgIFxuICBcblxufSJdfQ==